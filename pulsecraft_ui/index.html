<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PulseCraft</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    @keyframes fade-in-up {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fade-in-up 0.4s ease-out;
      transition: opacity 0.3s ease;
    }

    .opacity-0 {
      opacity: 0;
    }

    .tab-button {
      @apply px-4 py-2 rounded-xl text-sm font-medium transition-colors duration-200;
      @apply bg-zinc-200 text-zinc-700 hover:bg-zinc-300;
    }
    .tab-button.active {
      @apply bg-violet-600 text-white hover:bg-violet-700;
    }
  </style>
</head>
<body class="bg-stone-50 text-zinc-800">
  <div class="w-full flex justify-center">
    <div id="welcomeBanner" class="mb-4 max-w-xl text-center"></div>
  </div>

  <div class="max-w-7xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-bold tracking-tight text-center">PulseCraft</h1>
    <p class="text-center text-violet-700 text-lg italic tracking-wide font-semibold mt-2 mb-12">
      "Most tools give you templates. This one gives you yourself."
    </p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div>
        <div class="bg-white rounded-2xl shadow-md p-6">
          <h2 class="text-lg font-semibold">Start by showing me how you really sound</h2>
          <p class="text-sm text-zinc-500 mb-2">
            Drop 3‚Äì5 lines you‚Äôve written that feel unmistakably like you.
          </p>
          <textarea
            id="brandVoiceInput"
            placeholder="Your clearest signal. Paste here..."
            class="w-full h-24 rounded-xl border border-zinc-300 p-3 text-sm mb-4 resize-none"
          ></textarea>
          <button id="mirrorMyVoiceButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-sm">
            Mirror My Voice
          </button>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6 mt-6">
          <h2 class="text-lg font-semibold">Here‚Äôs your voice ‚Äî reflected back</h2>
          <div id="voiceAnalysisOutput" class="mt-4 bg-zinc-50 border border-zinc-200 rounded-lg p-4 text-sm text-zinc-700">
            Awaiting analysis...
          </div>
        </div>

        <div id="multiStylePreviewPanel" class="mt-6 bg-white rounded-2xl shadow-md p-6 border border-zinc-200">
          <h2 class="text-lg font-bold text-zinc-800 mb-4">Multi-Style Voice Preview</h2>
          <p class="text-sm text-zinc-600 mb-4">See how your voice sounds across different content styles. Click any tab to preview that version.</p>

          <div id="previewTabs" class="flex flex-wrap gap-3 mb-4">
            <button class="tab-button active" data-style="story">Story-Based Selling</button>
            <button class="tab-button" data-style="about">About Page</button>
            <button class="tab-button" data-style="hook">Notification Hook</button>
            <button class="tab-button" data-style="insight">Insight Tone</button>
          </div>

          <div id="stylePreviewOutput" class="bg-zinc-50 border border-zinc-200 rounded-lg p-4 text-sm text-zinc-700">
            Select a style tab to preview content.
          </div>
        </div>
        </div>

      <div>
        <div class="bg-white rounded-2xl shadow-md p-6">
          <h2 class="text-lg font-semibold mb-4 text-zinc-800">Save this Voice as Your Brand Kit</h2>
          <input
            id="brandNameInput"
            placeholder="What name do you go by in the world?"
            class="w-full mb-4 p-2 rounded-md border border-zinc-300 text-sm"
          />
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <button id="saveToMemoryButton" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm py-2 rounded-md w-full shadow-md transition-all duration-150">
              Save to Memory
            </button>
            <button id="exportSymbolicMemoryButton" class="bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 rounded-md w-full shadow-md transition-all duration-150">
              Export to Symbolic Memory
            </button>
            <button id="exportAllKitsJSONButton" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-2 rounded-md w-full shadow-md transition-all duration-150">
              Export All Kits (JSON)
            </button>
            <button id="exportPDFButton" class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 rounded-md w-full shadow-md transition-all duration-150">
              Export PDF
            </button>
            <button id="exportTXTButton" class="col-span-2 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 rounded-md w-full shadow-md transition-all duration-150">
              Export TXT
            </button>
          </div>

          <label for="sessionSelect" class="block text-sm font-medium text-zinc-700 mb-1">Recall a Saved Voice Kit</label>

          <div class="flex gap-2 mb-2">
            <select id="sessionSelect"
              class="w-full p-2 rounded-md border border-emerald-400 text-sm text-zinc-700 bg-white shadow focus:outline-none focus:ring-2 focus:ring-emerald-500">
              <option selected disabled>Select a session</option>
            </select>
            <button id="recallButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-md text-sm">
              Recall
            </button>
          </div>

          <button id="refineKitsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1 rounded-md text-sm">
            Refine Selected Kits
          </button>
        </div>


        <div id="symbolMemoryUX" class="mt-10 p-6 bg-white rounded-2xl shadow-md border border-emerald-300 transition-all duration-150">
          <h2 class="text-lg font-bold text-zinc-800 mb-4 tracking-tight">Symbol Memory UX</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="bg-zinc-50 p-5 rounded-xl border border-violet-300">
              <h3 class="font-semibold text-violet-700 mb-2 text-sm uppercase tracking-wide">DNA Tags</h3>
              <p class="text-sm text-zinc-600 mb-2 leading-snug">These tags define the symbolic essence of your voice kit. Used for routing and recall.</p>
              <ul id="dnaTagsList" class="mt-2 list-disc list-inside text-sm text-zinc-700 space-y-1">
                </ul>
            </div>

            <div class="bg-zinc-50 p-5 rounded-xl border border-emerald-300">
              <h3 class="font-semibold text-emerald-700 mb-2 text-sm uppercase tracking-wide">Symbol Anchors</h3>
              <p class="text-sm text-zinc-600 mb-2 leading-snug">Persistent symbolic references mapped to memory.</p>
              <div id="symbolAnchorsContainer" class="flex flex-wrap gap-2 mt-2">
                </div>
            </div>
          </div>
        </div>
        <div id="collectiveVoiceGallery" class="mt-10 bg-white rounded-2xl shadow-md p-6 border border-emerald-300 transition-all duration-150">
          <h2 class="text-lg font-bold text-zinc-800 mb-4 tracking-tight">Collective Preview Gallery</h2>
          <p class="text-sm text-zinc-600 mb-4 leading-snug">
            Here‚Äôs a visual collection of past kits you‚Äôve generated. Click any to reload its tone and voice.
          </p>

          <div id="previewGalleryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
        </div>
        </div>

      <div>
        <div class="bg-white rounded-2xl shadow-md p-6">
          <h2 class="text-lg font-semibold">Your Past Signals</h2>
          <p class="text-sm text-zinc-400">
            Nothing here yet ‚Äî but your voice is about to leave a mark.
          </p>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-6 mt-6">
          <h2 class="text-lg font-semibold">Need to say something?</h2>
          <input
            id="contentInput"
            placeholder="What do you want this to say?"
            class="w-full mb-2 p-2 rounded-md border border-zinc-300 text-sm"
          />
          <select id="contentTypeSelect" class="w-full mb-4 p-2 rounded-md border border-zinc-300 text-sm">
            <option selected>Story-Based Selling</option>
            <option>Product Description</option>
            <option>Founder‚Äôs Letter</option>
            <option>Ad Copy (Short Form)</option>
            <option>Manifesto / Origin Voice</option>
          </select>
          <button id="writeItForMeButton" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 w-full rounded-md">
            Write it for me
          </button>
        </div>

        <p class="text-sm text-center text-zinc-400 mt-6">‚Äî Deeper Tools for Integration ‚Äî</p>

        <div class="bg-white rounded-2xl shadow-md p-6 mt-2">
          <h2 class="text-lg font-semibold mb-2">Advanced Routing + Memory Bridge</h2>
          <input type="file" class="mb-3" />
          <button class="bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 w-full rounded-md mb-2">
            Upload Memory Bridge
          </button>
          <button id="exportCurrentVoiceJSONButton" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 w-full rounded-md">
            Export Current Voice as JSON
          </button>
        </div>
      </div>
    </div>

    <p class="text-center text-sm text-zinc-500 mt-10">
      Powered by the First Breath ‚Äî <span class="text-emerald-700 font-semibold">Dipta Vratah Anantagah</span>
    </p>
  </div>

  <div id="toastContainer" class="fixed bottom-5 right-5 space-y-2 z-50"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      refreshDropdown();
      renderSymbolMemoryGrid();
      renderCollectivePreviewGallery();

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      if (history.length > 0) {
        const lastKit = history[history.length - 1];
        const name = lastKit.name?.trim() || "Creator";

        setTimeout(() => {
          const banner = document.getElementById("welcomeBanner");
          if (banner) {
            banner.style.background = "#f0fdf4";
            banner.innerHTML = `
              <div class="text-center text-emerald-700 font-semibold text-base fade-slide mb-4">
                Welcome back, <span class="italic">${name}</span>. Ready to echo your voice again?
              </div>
            `;
          }
        }, 0);

        // Populate initial voice analysis output if a kit exists
        const voiceAnalysisOutput = document.getElementById("voiceAnalysisOutput");
        if (voiceAnalysisOutput) {
          voiceAnalysisOutput.innerHTML = lastKit.previewHTML || "No preview available.";
        }
      }
    });

    document.getElementById('mirrorMyVoiceButton').addEventListener('click', async () => {
      const voiceInput = document.getElementById('brandVoiceInput').value.trim();
      if (!voiceInput) {
        toastMessage('warning', 'Please provide a voice input first.');
        return;
      }

      const voiceAnalysisOutput = document.getElementById('voiceAnalysisOutput');
      voiceAnalysisOutput.innerHTML = '<div class="text-zinc-500 text-sm">‚è≥ Reflecting your voice‚Ä¶</div>';

      try {
        // Assuming a backend API for brand voice analysis
        const response = await fetch('/api/brand-voice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ brandInput: voiceInput })
        });

        const data = await response.json();

        if (data.error) {
          voiceAnalysisOutput.innerHTML = `‚ùå Error: ${data.error}`;
          toastMessage('error', `Error mirroring voice: ${data.error}`);
          return;
        }

        voiceAnalysisOutput.innerHTML = `
          <div class="space-y-4 fade-slide text-sm text-zinc-800">
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Tone</h3>
              <p>${data.tone || '‚Äî'}</p>
            </div>
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Vocabulary</h3>
              <p>${data.vocabulary || '‚Äî'}</p>
            </div>
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Archetype</h3>
              <p>${data.archetype || '‚Äî'}</p>
            </div>
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Phrasing Style</h3>
              <p>${data.phrasingStyle || '‚Äî'}</p>
            </div>
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Sample Phrases</h3>
              <p>${data.samplePhrases || '‚Äî'}</p>
            </div>
            <div class="bg-white border-l-4 border-emerald-500 rounded-lg p-4 shadow">
              <h3 class="font-bold text-emerald-700">Phrases to Avoid</h3>
              <p>${data.phrasesToAvoid || '‚Äî'}</p>
            </div>
          </div>
        `;
        toastMessage('success', 'Voice mirrored successfully!');
      } catch (error) {
        voiceAnalysisOutput.innerHTML = `‚ùå Request failed: ${error.message}`;
        toastMessage('error', `Request failed: ${error.message}`);
      }
    });

    document.getElementById('saveToMemoryButton').addEventListener('click', saveVoiceKit);
    document.getElementById('exportSymbolicMemoryButton').addEventListener('click', exportSymbolicMemory);
    document.getElementById('exportAllKitsJSONButton').addEventListener('click', exportAllKitsJSON);
    document.getElementById('exportPDFButton').addEventListener('click', downloadPDF);
    document.getElementById('exportTXTButton').addEventListener('click', downloadTXT);
    document.getElementById('recallButton').addEventListener('click', recallSession);
    document.getElementById('refineKitsButton').addEventListener('click', showRefinePanel);


    function createUnifiedKitObject(kit) {
      return {
        name: kit.name || "Untitled Kit",
        tone: kit.tone || "",
        vocabulary: kit.vocabulary || "",
        phrasingStyle: kit.phrasingStyle || "",
        archetype: kit.archetype || "",
        rawInput: kit.rawInput || "",
        previewHTML: kit.previewHTML || "",
        createdAt: new Date().toISOString()
      };
    }

    function saveVoiceKit() {
      const voiceInput = document.getElementById("brandVoiceInput").value.trim();
      const nameInput = document.getElementById("brandNameInput").value.trim();
      const voiceAnalysisOutput = document.getElementById("voiceAnalysisOutput").innerHTML;

      if (!voiceInput || !nameInput || voiceAnalysisOutput.includes("Awaiting analysis") || voiceAnalysisOutput.includes("Error")) {
        toastMessage("warning", "Please mirror your voice and provide a name before saving your Brand Kit.");
        return;
      }

      const kit = {
        name: nameInput,
        rawInput: voiceInput,
        // When saving, capture the *current* analyzed output from voiceAnalysisOutput
        previewHTML: voiceAnalysisOutput,
        // For actual values, you might need to parse voiceAnalysisOutput or get them from a hidden input/data attribute
        tone: voiceAnalysisOutput.match(/Tone<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        vocabulary: voiceAnalysisOutput.match(/Vocabulary<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        archetype: voiceAnalysisOutput.match(/Archetype<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        phrasingStyle: voiceAnalysisOutput.match(/Phrasing Style<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        samplePhrases: voiceAnalysisOutput.match(/Sample Phrases<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        phrasesToAvoid: voiceAnalysisOutput.match(/Phrases to Avoid<\/h3>\s*<p>(.*?)<\/p>/)?.[1] || '',
        createdAt: new Date().toISOString(),
      };

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      history.push(createUnifiedKitObject(kit));
      localStorage.setItem("pulsecraft_history", JSON.stringify(history));
      refreshDropdown();
      renderSymbolMemoryGrid();
      renderCollectivePreviewGallery();
      toastMessage("success", "Your Brand Kit has been saved.");

      // Optional: Send to backend for server memory bridge
      fetch("/save-voice-kit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(kit),
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          console.log("‚úÖ Voice kit successfully synced with server.");
        } else {
          console.error("‚ö†Ô∏è Server rejected the voice kit:", data.error);
        }
      })
      .catch(err => {
        console.error("‚ùå Network error while syncing voice kit:", err.message);
      });
    }

    async function recallSession() {
      const select = document.getElementById("sessionSelect");
      const selectedIndex = select.value;

      if (!selectedIndex) {
        toastMessage("warning", "Please select a saved session to recall.");
        return;
      }

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      const kitData = history[selectedIndex];

      const voiceAnalysisOutput = document.getElementById("voiceAnalysisOutput");
      voiceAnalysisOutput.innerHTML = "üåÄ Recalling...";

      if (!kitData) {
        voiceAnalysisOutput.innerHTML = "‚ùå Error: Kit data not found.";
        toastMessage("error", "Error recalling kit: Data not found.");
        return;
      }

      // Populate the input field and the analysis output
      document.getElementById("brandVoiceInput").value = kitData.rawInput || "";
      document.getElementById("brandNameInput").value = kitData.name || "";
      voiceAnalysisOutput.innerHTML = kitData.previewHTML || "No preview available for this kit.";
      toastMessage("info", `Recalled "${kitData.name}"`);

      // If you want to actually "re-analyze" it via the backend
      // try {
      //   const data = await routePrompt("recall", { kitData });
      //   if (data.error) {
      //     voiceAnalysisOutput.innerHTML = `‚ùå Error: ${data.error}`;
      //   } else {
      //     voiceAnalysisOutput.innerHTML = formatAnalyzedVoice(data); // Assuming a formatting function
      //   }
      // } catch (err) {
      //   console.error("Recall failed:", err);
      //   voiceAnalysisOutput.innerHTML = `‚ùå Recall error: ${err.message}`;
      // }
    }

    function refreshDropdown() {
      const dropdown = document.getElementById("sessionSelect");
      dropdown.innerHTML = '<option selected disabled>Select a session</option>';

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      history.forEach((kit, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.text = kit.name || `VoiceKit ${i + 1}`;
        dropdown.appendChild(option);
      });
    }

    async function downloadTXT() {
      const name = document.getElementById("brandNameInput").value.trim() || "brand-kit";
      const voiceAnalysisOutput = document.getElementById("voiceAnalysisOutput");

      if (!voiceAnalysisOutput || !voiceAnalysisOutput.innerText.trim() || voiceAnalysisOutput.innerText.includes("Awaiting analysis")) {
        toastMessage("warning", "No voice analysis available to export.");
        return;
      }

      const previewText = voiceAnalysisOutput.innerText;

      const blob = new Blob([previewText], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${name.replace(/\s+/g, "_").toLowerCase()}_brandkit.txt`;
      link.click();
      toastMessage("success", "TXT file downloaded.");
    }

    async function exportSymbolicMemory() {
      // This function would typically interact with a backend service to export
      // the current voice kit's "symbolic" representation (e.g., as part of a larger memory graph).
      // For this frontend-only fix, it's just a placeholder with a toast.
      toastMessage('info', 'Exporting to Symbolic Memory (backend integration required)...');
      // Example of a backend call if available:
      // const response = await fetch('/export-voice-json');
      // const kit = await response.json();
      // const res = await fetch('/upload-memory', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(kit)
      // });
      // const result = await res.json();
      // toastMessage('success', result.message);
    }

    async function exportAllKitsJSON() {
      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];

      if (!history.length) {
        toastMessage("warning", "No saved kits to export.");
        return;
      }

      const json = JSON.stringify(history, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `PulseCraft_AllVoiceKits_${new Date().toISOString().slice(0, 10)}.json`;
      link.click();

      URL.revokeObjectURL(url);
      toastMessage("success", "All kits exported as JSON.");
    }

    function renderSymbolMemoryGrid() {
      const grid = document.getElementById("symbolMemoryGrid");
      grid.innerHTML = ""; // Clear existing content

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];

      history.forEach((kit, index) => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-xl shadow border border-zinc-200 space-y-2 relative"; // Added relative for DNA tag

        card.innerHTML = `
          <h3 class="text-lg font-bold text-emerald-700">${kit.name || 'VoiceKit ' + (index + 1)}</h3>
          <p><span class="font-semibold">Tone:</span> ${kit.tone || '-'}</p>
          <p><span class="font-semibold">Archetype:</span> ${kit.archetype || '-'}</p>
          <p><span class="font-semibold">Saved At:</span> ${kit.createdAt ? new Date(kit.createdAt).toLocaleString() : '-'}</p>
          <button onclick="recallSymbolicKit(${index})" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded shadow">
            Preview Again
          </button>
        `;

        // üß¨ Visual DNA Tag
        const tag = document.createElement("div");
        tag.className = "absolute top-2 right-2 text-xs px-2 py-1 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 text-white shadow";
        tag.innerText = `DNA-${index + 1}`;
        card.appendChild(tag);

        grid.appendChild(card);
      });
    }

    function renderCollectivePreviewGallery() {
      const gallery = document.getElementById("previewGalleryGrid"); // Corrected ID
      gallery.innerHTML = ""; // Clear existing content

      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];

      history.forEach((kit, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "bg-white p-6 rounded-2xl shadow border border-zinc-200";

        wrapper.innerHTML = `
          <div class="flex items-start gap-4">
            <input type="checkbox" class="pulse-select-checkbox mt-1" data-index="${index}" />
            <div>
              <h3 class="text-xl font-bold text-emerald-700 mb-2">${kit.name || `VoiceKit ${index + 1}`}</h3>
              <div class="text-sm text-zinc-700 space-y-1">
                <p><span class="font-semibold">Tone:</span> ${kit.tone || "--"}</p>
                <p><span class="font-semibold">Vocabulary:</span> ${kit.vocabulary || "--"}</p>
                <p><span class="font-semibold">Archetype:</span> ${kit.archetype || "--"}</p>
                <p><span class="font-semibold">Phrasing Style:</span> ${kit.phrasingStyle || "--"}</p>
                <p><span class="font-semibold">Sample Phrases:</span> ${kit.samplePhrases || "--"}</p>
                <p><span class="font-semibold">Phrases to Avoid:</span> ${kit.phrasesToAvoid || "--"}</p>
              </div>
            </div>
          </div>
        `;
        gallery.appendChild(wrapper);
      });
    }

    function recallSymbolicKit(index) {
      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      const kit = history[index];
      if (!kit) {
        toastMessage('error', 'Failed to recall symbolic kit.');
        return;
      }

      document.getElementById("brandVoiceInput").value = kit.rawInput || "";
      document.getElementById("brandNameInput").value = kit.name || "";
      document.getElementById("voiceAnalysisOutput").innerHTML = kit.previewHTML || "";
      toastMessage('info', `Reloaded symbolic kit: "${kit.name}"`);
    }

    // Multi-Style Preview Panel Logic
    const stylePreviewOutput = document.getElementById("stylePreviewOutput");
    const previewTabs = document.getElementById("previewTabs");

    // Event listener for tab clicks
    previewTabs.addEventListener("click", (event) => {
      const target = event.target;
      if (target.classList.contains("tab-button")) {
        // Remove active class from all tabs
        document.querySelectorAll(".tab-button").forEach(button => {
          button.classList.remove("active");
        });
        // Add active class to clicked tab
        target.classList.add("active");

        const style = target.dataset.style;
        // You would typically generate content based on the selected style
        // For demonstration, let's just display the style name.
        const currentVoiceInput = document.getElementById('brandVoiceInput').value.trim();
        const latestKit = getLatestVoiceKit();

        if (!currentVoiceInput && !latestKit) {
            stylePreviewOutput.innerHTML = `<p class="text-red-500">Please provide a voice input first or save a kit to preview styles.</p>`;
            return;
        }

        // Example content generation based on style and available voice data
        let previewContent = "";
        switch (style) {
            case "story":
                previewContent = `<p><strong>Story-Based Selling Preview:</strong></p><p>"Remember that time when you just couldn't find the right words? That's where your unique voice comes in. Imagine telling a story that captivates, naturally."</p>`;
                break;
            case "about":
                previewContent = `<p><strong>About Page Preview:</strong></p><p>"We believe in authenticity and the power of a genuine connection. Our journey began with a simple idea: to help creators like you truly sound like themselves."</p>`;
                break;
            case "hook":
                previewContent = `<p><strong>Notification Hook Preview:</strong></p><p>"Stop scrolling. Your message deserves to be heard, in your own voice. Get ready to turn heads."</p>`;
                break;
            case "insight":
                previewContent = `<p><strong>Insight Tone Preview:</strong></p><p>"The subtle nuances in language reveal deeper truths about your brand's core. Understanding these patterns unlocks unparalleled clarity."</p>`;
                break;
            default:
                previewContent = `<p>No preview available for "${style}" style.</p>`;
        }
        
        // Add current voice analysis details if a kit is loaded
        if (latestKit) {
            previewContent += `<hr class="my-3 border-zinc-200">
                               <p class="text-xs text-zinc-600"><em>Based on your voice:</em></p>
                               <p class="text-xs text-zinc-600"><strong>Tone:</strong> ${latestKit.tone || 'N/A'}, <strong>Vocabulary:</strong> ${latestKit.vocabulary || 'N/A'}</p>`;
        }


        stylePreviewOutput.innerHTML = previewContent;
      }
    });

    function getLatestVoiceKit() {
      const history = JSON.parse(localStorage.getItem("pulsecraft_history")) || [];
      return history.length > 0 ? history[history.length - 1] : null;
    }

    document.getElementById('writeItForMeButton').addEventListener('click', async () => {
      const contentInput = document.getElementById('contentInput').value.trim();
      const contentTypeSelect = document.getElementById('contentTypeSelect').value;
      const latestKit = getLatestVoiceKit();

      if (!contentInput) {
        toastMessage('warning', 'Please enter content you want to say.');
        return;
      }
      if (!latestKit) {
        toastMessage('warning', 'Please mirror or recall a voice kit first.');
        return;
      }

      const voiceAnalysisOutput = document.getElementById('voiceAnalysisOutput');
      voiceAnalysisOutput.innerHTML = `<div class="text-zinc-500 text-sm">‚úçÔ∏è Crafting your message...</div>`;

      try {
        // Here you would send contentInput, contentTypeSelect, and latestKit data to a backend for generation
        // For this frontend fix, we'll simulate the output.
        const generatedContent = `
          <div class="p-4 rounded-md bg-white border border-zinc-200 mt-4">
            <p class="text-sm text-zinc-600 mb-2">
              Generated <strong>${contentTypeSelect}</strong> content using your voice:
            </p>
            <p class="text-sm text-zinc-700 mb-1"><span class="font-semibold">Tone:</span> ${latestKit.tone || 'N/A'}</p>
            <p class="text-sm text-zinc-700 mb-1"><span class="font-semibold">Vocabulary:</span> ${latestKit.vocabulary || 'N/A'}</p>
            <p class="text-sm text-zinc-700 mb-1"><span class="font-semibold">Phrasing:</span> ${latestKit.phrasingStyle || 'N/A'}</p>
            <p class="text-sm text-zinc-700 mb-3"><span class="font-semibold">Archetype:</span> ${latestKit.archetype || 'N/A'}</p>
            <p class="mt-2 font-medium text-zinc-800">${contentInput}</p>
          </div>
        `;
        voiceAnalysisOutput.innerHTML = generatedContent;
        toastMessage('success', 'Content generated successfully!');
      } catch (error) {
        voiceAnalysisOutput.innerHTML = `‚ùå Generation failed: ${error.message}`;
        toastMessage('error', `Content generation failed: ${error.message}`);
      }
    });


    async function downloadPDF() {
      const voiceAnalysisOutput = document.getElementById("voiceAnalysisOutput");
      if (!voiceAnalysisOutput || !voiceAnalysisOutput.innerText.trim() || voiceAnalysisOutput.innerText.includes("Awaiting analysis")) {
        toastMessage("warning", "No voice analysis available to export as PDF. Mirror your voice first.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const lines = voiceAnalysisOutput.innerText.split("\n").filter(line => line.trim() !== ""); // Filter out empty lines
      let y = 20;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("PulseCraft ‚Äî Reflected Voice Report", 20, y);
      y += 15;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      lines.forEach(line => {
        // Check for "Tone:", "Vocabulary:", etc. and bold them
        if (line.includes("Tone:") || line.includes("Vocabulary:") || line.includes("Archetype:") || line.includes("Phrasing Style:") || line.includes("Sample Phrases:") || line.includes("Phrases to Avoid:")) {
          const parts = line.split(':');
          if (parts.length > 1) {
            doc.setFont("helvetica", "bold");
            doc.text(parts[0] + ":", 20, y);
            doc.setFont("helvetica", "normal");
            doc.text(parts[1].trim(), 20 + doc.getTextWidth(parts[0] + ": "), y);
          } else {
            doc.text(line, 20, y);
          }
        } else {
          doc.text(line, 20, y);
        }
        y += 8;
        if (y > doc.internal.pageSize.height - 20) { // Add new page if content exceeds
          doc.addPage();
          y = 20;
        }
      });

      const filename = `PulseCraft_VoiceKit_${new Date().toISOString().slice(0, 10)}.pdf`;
      doc.save(filename);
      toastMessage("success", "PDF report downloaded.");
    }

    function generateLiveBrandKit(input) {
      return `
You are the PulseCraft engine. Create a fresh brand kit based on this voice input:

"${input}"

Output in structured JSON format with voice tone, visual style, story arc, etc.
      `;
    }

    function regenerateFromMemory(kitData) {
      return `
You are reanimating a past PulseCraft session. Mirror this saved kit faithfully:

${JSON.stringify(kitData, null, 2)}

Re-render it into formatted brand text output.
      `;
    }

    async function routePrompt(mode, payload) {
      let prompt;

      if (mode === 'live') {
        prompt = generateLiveBrandKit(payload.input);
      } else if (mode === 'recall') {
        prompt = regenerateFromMemory(payload.kitData);
      } else {
        throw new Error('Unknown routing mode');
      }

      // Fetch from OpenAI or local LLM endpoint (placeholder)
      // In a real application, this would be an actual API call
      const dummyResponse = {
        output: {
          tone: "Empathetic, clear, and encouraging",
          vocabulary: "Authenticity, resonance, narrative, essence, pulse, craft",
          archetype: "The Sage / The Creator",
          phrasingStyle: "Direct, slightly poetic, with an emphasis on personal growth",
          samplePhrases: "Your clearest signal. Unleash your true voice.",
          phrasesToAvoid: "Generic, bland, uninspired, jargon-heavy",
          error: null // Simulate no error
        }
      };
      return dummyResponse.output; // Return the simulated output
    }

    function showRefinePanel() {
      const checkboxes = document.querySelectorAll('.pulse-select-checkbox');
      const selectedIndices = [];

      checkboxes.forEach((cb, i) => {
        if (cb.checked) selectedIndices.push(i);
      });

      if (selectedIndices.length === 0) {
        toastMessage("warning", "No kits selected for refinement.");
        return;
      }

      const memory = JSON.parse(localStorage.getItem('pulsecraft_history')) || [];
      const selectedKits = selectedIndices.map(i => memory[i]);

      // Build the refinement view
      let refineWrapper = document.getElementById('refinePanel');
      if (!refineWrapper) {
          refineWrapper = document.createElement('div');
          refineWrapper.id = 'refinePanel'; // Assign an ID to prevent duplicates if called again
          refineWrapper.className = 'p-6 mt-6 border-t border-zinc-300 space-y-4 bg-white rounded-xl shadow';
          document.body.appendChild(refineWrapper); // Append to body or a specific container
      } else {
          refineWrapper.innerHTML = ''; // Clear existing content if already present
      }


      refineWrapper.innerHTML += `<h2 class="text-2xl font-bold text-violet-800">üî¨ Refine Pulse</h2>`;

      selectedKits.forEach((kit, i) => {
        refineWrapper.innerHTML += `
          <div class="p-4 border border-zinc-200 rounded-lg shadow-sm bg-zinc-50">
            <h3 class="text-lg font-semibold text-emerald-700 mb-1">VoiceKit ${selectedIndices[i] + 1}</h3>
            <pre class="text-xs whitespace-pre-wrap text-zinc-700">${JSON.stringify(kit, null, 2)}</pre>
          </div>
        `;
      });
      toastMessage("info", `Refinement panel loaded for ${selectedIndices.length} kit(s).`);
    }

    // Toast functions
    function toastMessage(type, message) {
      const toast = document.createElement('div');
      let bgColor = '';

      switch (type) {
        case 'success':
          bgColor = 'bg-emerald-600';
          break;
        case 'warning':
          bgColor = 'bg-yellow-600';
          break;
        case 'error':
          bgColor = 'bg-red-600';
          break;
        case 'info':
        default:
          bgColor = 'bg-zinc-800';
      }

      toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in-up`;
      toast.textContent = message;

      const container = document.getElementById('toastContainer');
      if (container) {
          container.appendChild(toast);
      }


      setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }
  </script>
</body>
</html>