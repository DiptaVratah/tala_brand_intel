---
phase: 01-landing-page--navigation
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - pulsecraft_ui/shapeshifter.js
  - pulsecraft_ui/script.js
  - pulsecraft_ui/index.html
  - pulsecraft_ui/router.js
autonomous: false

must_haves:
  truths:
    - "User clicking mode card navigates to clean URL path (e.g., /branding)"
    - "User on /branding sees branding interface (not landing page)"
    - "User pressing browser back button returns to landing page"
    - "User returning to site sees prompt to continue with previous mode"
    - "User pasting /author into browser sees author interface directly"
    - "User no longer sees Consciousness Mode or Deep Mode in mode switcher dropdown"
  artifacts:
    - path: "pulsecraft_ui/shapeshifter.js"
      provides: "Path-based mode detection replacing query params"
      contains: "window.location.pathname"
    - path: "pulsecraft_ui/router.js"
      provides: "Initialized router with route handlers and return visit handling"
      contains: ["showLanding", "handleReturnVisit"]
  key_links:
    - from: "pulsecraft_ui/router.js"
      to: "pulsecraft_ui/shapeshifter.js"
      via: "loadMode function calling shapeshifter.setMode"
      pattern: "loadMode|setMode"
    - from: ".mode-card-button"
      to: "router.navigate"
      via: "click event handler"
      pattern: "addEventListener.*click.*navigate"
    - from: "pulsecraft_ui/shapeshifter.js"
      to: "localStorage"
      via: "mode persistence and retrieval"
      pattern: "localStorage\\.(get|set)Item.*mode"
    - from: "pulsecraft_ui/router.js"
      to: "localStorage"
      via: "return visit detection on page load"
      pattern: "pulsecraft_last_mode"
---

<objective>
Wire router to existing app, implement mode state persistence with return visit handling, and verify complete navigation flow.

Purpose: Connect the landing page infrastructure (Plan 01) to the existing shapeshifter/progressive system, replacing query parameters with clean path-based URLs. Implement ROUT-05 return visit mode persistence.

Output: Fully working navigation between landing page and mode interfaces with browser history support and return visit prompts.
</objective>

<execution_context>
@/Users/dipta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dipta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-landing-page--navigation/01-RESEARCH.md
@.planning/phases/01-landing-page--navigation/01-01-SUMMARY.md
@pulsecraft_ui/router.js
@pulsecraft_ui/shapeshifter.js
@pulsecraft_ui/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize router and wire landing page navigation</name>
  <files>pulsecraft_ui/router.js, pulsecraft_ui/index.html</files>
  <action>
Update router.js to initialize with route handlers and wire card button clicks.

**router.js additions (at bottom of file, after class definition):**

1. Add view toggle functions:
   ```javascript
   function showLanding() {
     const landingView = document.getElementById('landingView');
     const appView = document.getElementById('appView');

     if (landingView) {
       landingView.classList.remove('hidden');
       landingView.style.display = 'block';
     }
     if (appView) {
       appView.classList.add('hidden');
       appView.style.display = 'none';
     }

     // Update page title
     document.title = 'PulseCraft: The Consciousness Interface';
   }

   function showApp() {
     const landingView = document.getElementById('landingView');
     const appView = document.getElementById('appView');

     if (landingView) {
       landingView.classList.add('hidden');
       landingView.style.display = 'none';
     }
     if (appView) {
       appView.classList.remove('hidden');
       appView.style.display = 'block';
     }
   }

   function loadMode(mode) {
     showApp();

     // Set mode in shapeshifter (will be updated in Task 2)
     if (window.pulsecraftShapeshifter) {
       window.pulsecraftShapeshifter.setMode(mode);
     }

     // Save to localStorage for return visits
     localStorage.setItem('pulsecraft_last_mode', mode);

     // Update page title
     const titles = {
       'branding': 'PulseCraft: Brand Voice Studio',
       'author': 'PulseCraft: Writing Voice Lab',
       'self-reflection': 'PulseCraft: Voice Mirror'
     };
     document.title = titles[mode] || 'PulseCraft';
   }
   ```

2. Initialize router with routes:
   ```javascript
   // Initialize router when DOM is ready
   function initRouter() {
     const router = new PulseCraftRouter({
       '/': showLanding,
       '/branding': () => loadMode('branding'),
       '/author': () => loadMode('author'),
       '/self-reflection': () => loadMode('self-reflection'),
       '*': () => {
         // Fallback: redirect to landing
         window.pulsecraftRouter.navigate('/');
       }
     });

     window.pulsecraftRouter = router;
     router.init();

     // Set up card button click handlers
     setupCardNavigation();
   }

   function setupCardNavigation() {
     const cardButtons = document.querySelectorAll('.mode-card-button');

     cardButtons.forEach(button => {
       button.addEventListener('click', (e) => {
         e.preventDefault();
         const path = button.getAttribute('data-path');
         if (path && window.pulsecraftRouter) {
           window.pulsecraftRouter.navigate(path, { mode: path.slice(1) });
         }
       });
     });

     // Also make entire card clickable
     const cards = document.querySelectorAll('.mode-card');
     cards.forEach(card => {
       card.addEventListener('click', (e) => {
         // Don't trigger if button was clicked (it handles itself)
         if (e.target.classList.contains('mode-card-button')) return;

         const button = card.querySelector('.mode-card-button');
         if (button) button.click();
       });

       // Add pointer cursor
       card.style.cursor = 'pointer';
     });
   }

   // Initialize when DOM ready
   if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initRouter);
   } else {
     initRouter();
   }
   ```

3. Export functions for use by shapeshifter:
   ```javascript
   // Expose functions globally for integration
   window.showLanding = showLanding;
   window.showApp = showApp;
   window.loadMode = loadMode;
   ```
  </action>
  <verify>
1. router.js contains showLanding, showApp, loadMode functions
2. router.js initializes with route handlers
3. Card click handlers are set up

Run:
```bash
grep -E "(showLanding|loadMode|setupCardNavigation|initRouter)" pulsecraft_ui/router.js | wc -l
# Should be >= 6
```
  </verify>
  <done>Router initializes with route handlers, card buttons navigate to mode paths, view toggling works</done>
</task>

<task type="auto">
  <name>Task 2: Update shapeshifter to use path-based routing</name>
  <files>pulsecraft_ui/shapeshifter.js</files>
  <action>
Modify shapeshifter.js to use path-based mode detection instead of query parameters.

**Changes to detectMode() method:**

1. Find the `detectMode()` method (around line 342)

2. REPLACE the entire detectMode method with path-based detection:
   ```javascript
   detectMode() {
     // 1. Check URL path (primary method - clean URLs)
     const pathname = window.location.pathname;
     const pathModeMap = {
       '/branding': 'branding',
       '/author': 'author',
       '/self-reflection': 'therapy'  // maps to 'therapy' mode internally
     };

     if (pathModeMap[pathname]) {
       return pathModeMap[pathname];
     }

     // 2. Check for query params (backward compatibility during transition)
     const urlParams = new URLSearchParams(window.location.search);
     const modeParam = urlParams.get('mode');
     if (modeParam && this.MODES[modeParam]) {
       // Redirect to clean URL
       const cleanPath = modeParam === 'therapy' ? '/self-reflection' : `/${modeParam}`;
       if (window.pulsecraftRouter) {
         window.pulsecraftRouter.navigate(cleanPath);
       }
       return modeParam;
     }

     // 3. Check domain (keep for future subdomain support)
     const hostname = window.location.hostname;
     if (hostname.includes('brand.')) return 'branding';
     if (hostname.includes('author.')) return 'author';
     if (hostname.includes('therapy.')) return 'therapy';

     // 4. Check localStorage preference (for return visits)
     const savedMode = localStorage.getItem('pulsecraft_mode');
     if (savedMode && this.MODES[savedMode]) {
       return savedMode;
     }

     // 5. Check for easter egg activation
     if (this.checkDeepActivation()) return 'deep';

     // 6. Default - return null to indicate landing page should show
     // (consciousness mode only activates when user explicitly chooses)
     return null;
   }
   ```

3. Add new `setMode(mode)` method after detectMode():
   ```javascript
   setMode(mode) {
     if (!mode || !this.MODES[mode]) {
       console.warn('shapeshifter.js: Invalid mode:', mode);
       return;
     }

     // Map self-reflection path to therapy mode
     if (mode === 'self-reflection') {
       mode = 'therapy';
     }

     this.mode = mode;
     this.applyMode();

     // Reset progressive system when mode changes
     if (window.progressiveSystem) {
       window.progressiveSystem.resetToPhaseOne();
     }
   }
   ```

4. Update init() method to handle landing page case:
   ```javascript
   init() {
     console.log('shapeshifter.js: Initializing with mode:', this.mode);

     // If mode is null (landing page), don't apply mode styling
     if (this.mode === null) {
       console.log('shapeshifter.js: No mode detected, landing page will show');
       return;
     }

     // Apply mode immediately
     this.applyMode();

     // Set up mode switcher (hidden by default)
     this.setupModeSwitcher();

     // Set up easter eggs
     this.setupEasterEggs();

     console.log('shapeshifter.js: Initialization complete');
   }
   ```

5. Update setupModeSwitcher() to not show on landing page:
   - Add check at start: `if (this.mode === null) return;`

6. REMOVE Consciousness Mode and Deep Mode from mode select (per UI-01):
   In setupModeSwitcher(), change the innerHTML to only show:
   ```html
   <option value="branding">Branding</option>
   <option value="author">Author</option>
   <option value="therapy">Self-Reflection</option>
   ```
   (Remove consciousness and deep options from the dropdown)
  </action>
  <verify>
1. detectMode uses window.location.pathname
2. setMode method exists
3. Mode dropdown no longer has consciousness/deep options in the dynamically created HTML

Run:
```bash
grep -E "(pathname|setMode|self-reflection)" pulsecraft_ui/shapeshifter.js | head -10

# Check that setupModeSwitcher dropdown HTML only has 3 modes
# Look for the select innerHTML generation - should NOT contain 'consciousness' or 'deep' as option values
grep -A20 'setupModeSwitcher' pulsecraft_ui/shapeshifter.js | grep -E '<option' | grep -v "branding\|author\|therapy" | wc -l
# Should be 0 (no options other than the 3 allowed modes)
```
  </verify>
  <done>Shapeshifter uses path-based mode detection, setMode method exists, Consciousness/Deep modes removed from dropdown</done>
</task>

<task type="auto">
  <name>Task 3: Implement return visit mode persistence</name>
  <files>pulsecraft_ui/router.js</files>
  <action>
Add return visit handling logic to router.js per ROUT-05 requirement.

**Add handleReturnVisit function after the initRouter function:**

```javascript
/**
 * Handles return visitors who have a saved mode preference.
 * Shows a "Continue" prompt on the landing page if user previously used a mode.
 * Pattern from RESEARCH.md lines 527-552.
 */
function handleReturnVisit() {
  const savedMode = localStorage.getItem('pulsecraft_last_mode');

  // Only show prompt if:
  // 1. User has a saved mode preference
  // 2. User is on the landing page (root path)
  if (!savedMode || window.location.pathname !== '/') {
    return;
  }

  // Validate saved mode is one of the allowed modes
  const allowedModes = ['branding', 'author', 'self-reflection'];
  if (!allowedModes.includes(savedMode)) {
    // Clear invalid saved mode
    localStorage.removeItem('pulsecraft_last_mode');
    return;
  }

  // Create and show the return visitor banner
  showContinuePrompt(savedMode);
}

/**
 * Shows a banner prompting the user to continue with their previous mode.
 * @param {string} mode - The previously saved mode
 */
function showContinuePrompt(mode) {
  // Don't show if banner already exists
  if (document.querySelector('.return-visitor-banner')) {
    return;
  }

  // Map mode to display name
  const modeNames = {
    'branding': 'Branding',
    'author': 'Author',
    'self-reflection': 'Self-Reflection'
  };
  const displayName = modeNames[mode] || mode;

  const banner = document.createElement('div');
  banner.className = 'return-visitor-banner';
  banner.innerHTML = `
    <p>Welcome back! Continue with <strong>${displayName}</strong>?</p>
    <div class="return-visitor-actions">
      <button class="continue-btn" data-mode="${mode}">Continue</button>
      <button class="start-fresh-btn">Start Fresh</button>
    </div>
  `;

  // Insert at top of landing view
  const landingView = document.getElementById('landingView');
  if (landingView) {
    landingView.insertBefore(banner, landingView.firstChild);
  }

  // Wire up button handlers
  const continueBtn = banner.querySelector('.continue-btn');
  const startFreshBtn = banner.querySelector('.start-fresh-btn');

  continueBtn.addEventListener('click', () => {
    const targetMode = continueBtn.getAttribute('data-mode');
    const path = targetMode === 'self-reflection' ? '/self-reflection' : `/${targetMode}`;
    if (window.pulsecraftRouter) {
      window.pulsecraftRouter.navigate(path);
    }
    banner.remove();
  });

  startFreshBtn.addEventListener('click', () => {
    // Clear saved mode preference
    localStorage.removeItem('pulsecraft_last_mode');
    banner.remove();
  });
}

// Expose for testing
window.handleReturnVisit = handleReturnVisit;
window.showContinuePrompt = showContinuePrompt;
```

**Update initRouter to call handleReturnVisit:**

Modify the initRouter function to call handleReturnVisit after router init:

```javascript
function initRouter() {
  const router = new PulseCraftRouter({
    '/': () => {
      showLanding();
      // Check for return visit after showing landing
      handleReturnVisit();
    },
    '/branding': () => loadMode('branding'),
    '/author': () => loadMode('author'),
    '/self-reflection': () => loadMode('self-reflection'),
    '*': () => {
      window.pulsecraftRouter.navigate('/');
    }
  });

  window.pulsecraftRouter = router;
  router.init();
  setupCardNavigation();
}
```

**Add CSS for return visitor banner to landing.css:**

Add these styles to pulsecraft_ui/landing.css:

```css
/* Return visitor banner */
.return-visitor-banner {
  background: linear-gradient(135deg, var(--color-accent-primary-green, #4CAF50) 0%, var(--color-accent-secondary-green, #45a049) 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin: 1rem auto 2rem;
  max-width: 600px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.return-visitor-banner p {
  margin: 0;
  font-size: 1.1rem;
}

.return-visitor-actions {
  display: flex;
  gap: 0.75rem;
}

.return-visitor-banner .continue-btn {
  background: white;
  color: var(--color-accent-primary-green, #4CAF50);
  border: none;
  padding: 0.5rem 1.25rem;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
}

.return-visitor-banner .continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.return-visitor-banner .start-fresh-btn {
  background: transparent;
  color: white;
  border: 2px solid white;
  padding: 0.5rem 1.25rem;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.15s;
}

.return-visitor-banner .start-fresh-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

@media (max-width: 600px) {
  .return-visitor-banner {
    flex-direction: column;
    text-align: center;
  }
}
```
  </action>
  <verify>
1. handleReturnVisit function exists in router.js
2. showContinuePrompt function exists in router.js
3. Return visitor banner CSS exists in landing.css
4. initRouter calls handleReturnVisit for '/' route

Run:
```bash
grep -E "(handleReturnVisit|showContinuePrompt|pulsecraft_last_mode)" pulsecraft_ui/router.js | wc -l
# Should be >= 5

grep -q "return-visitor-banner" pulsecraft_ui/landing.css && echo "Banner CSS found" || echo "MISSING"
```
  </verify>
  <done>Return visit handling implemented: saves mode to localStorage on navigation, shows "Continue with X?" prompt on return visits to landing page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete navigation flow</name>
  <what-built>
    - Landing page with 3 mode selection cards
    - Path-based routing (/branding, /author, /self-reflection)
    - Browser back/forward navigation
    - Mode state persistence with return visit prompt
    - Consciousness/Deep mode removal from dropdown
  </what-built>
  <how-to-verify>
    Start the server if not running:
    ```bash
    cd /Users/dipta/tala_brand_intel && npm start
    ```

    Then test these scenarios:

    1. **Landing Page Display:**
       - Open http://localhost:3000/ in browser
       - EXPECTED: See landing page with PulseCraft title, tagline "Most tools give you templates...", and 3 mode cards (Branding, Author, Self-Reflection)
       - VERIFY: No navigation bar, clean minimal design

    2. **Mode Card Navigation:**
       - Click "Start Building" on Branding card
       - EXPECTED: URL changes to /branding, page shows Branding interface (blue theme)
       - VERIFY: Address bar shows `localhost:3000/branding` (no ?mode=)

    3. **Browser Back Button:**
       - Press browser back button
       - EXPECTED: Returns to landing page at /
       - VERIFY: Landing page displays, URL is /

    4. **Forward Button:**
       - Press browser forward button
       - EXPECTED: Returns to /branding with Branding interface

    5. **Direct URL Access:**
       - Open new tab, paste http://localhost:3000/author
       - EXPECTED: Author interface loads directly (not landing page, not 404)
       - VERIFY: Red/orange theme, author-specific language

    6. **Self-Reflection Route:**
       - Navigate to http://localhost:3000/self-reflection
       - EXPECTED: Self-Reflection interface loads (green/calm theme)
       - VERIFY: Supportive language like "Reflect My Voice"

    7. **Return Visit Preference (ROUT-05):**
       - While on /branding, close the tab
       - Open new tab to http://localhost:3000/
       - EXPECTED: Landing page shows WITH "Welcome back! Continue with Branding?" banner at top
       - VERIFY: Banner has "Continue" and "Start Fresh" buttons
       - Click "Continue" - should navigate to /branding
       - OR Click "Start Fresh" - banner disappears, stays on landing

    8. **No Consciousness/Deep in Dropdown (UI-01):**
       - While in any mode, check the mode switcher dropdown (if visible)
       - EXPECTED: Only Branding, Author, Self-Reflection options
       - VERIFY: No "Consciousness" or "0xDEEP" options visible
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After human approval:

1. **All routes work:**
   - / shows landing
   - /branding shows branding mode
   - /author shows author mode
   - /self-reflection shows self-reflection mode

2. **Browser navigation works:**
   - Back/forward buttons work correctly
   - Direct URL access works

3. **Return visit works:**
   - Mode saved to localStorage on navigation
   - "Continue" prompt appears on return to /

4. **No regressions:**
   - Existing progressive reveal system still works
   - Voice mirroring still works
   - API routes still work
   - No Consciousness/Deep modes in dropdown
</verification>

<success_criteria>
- [ ] Mode card clicks navigate to clean URL paths
- [ ] Browser back button returns to landing page
- [ ] Browser forward button returns to mode
- [ ] Direct URL access works (no 404)
- [ ] Return visitors see "Continue with X?" prompt on landing page
- [ ] Mode switcher dropdown has only Branding/Author/Self-Reflection (not 5 modes)
- [ ] Landing page displays tagline "Most tools give you templates. This one gives you yourself."
- [ ] Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/01-landing-page--navigation/01-02-SUMMARY.md`
</output>
