---
phase: 02-interface-differentiation
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - pulsecraft_ui/shapeshifter.js
  - pulsecraft_ui/style.css
  - pulsecraft_ui/index.html
autonomous: true

must_haves:
  truths:
    - "Loading overlay shows 'Analyzing brand voice...' in Branding mode"
    - "Loading overlay shows 'Capturing your style...' in Author mode"
    - "Loading overlay shows 'Reflecting on your words...' in Self-Reflection mode"
    - "Error messages have mode-appropriate prefixes"
    - "Success feedback uses mode-specific language"
    - "Toast notifications are styled with mode accent colors"
  artifacts:
    - path: "pulsecraft_ui/shapeshifter.js"
      provides: "showLoading, hideLoading, showError, showSuccess functions"
      contains: "showLoading"
    - path: "pulsecraft_ui/style.css"
      provides: "Toast notification styles with mode colors"
      contains: ".toast"
    - path: "pulsecraft_ui/index.html"
      provides: "Toast container element"
      contains: "toastContainer"
  key_links:
    - from: "shapeshifter.js showLoading()"
      to: "LANGUAGE_MATRIX.loadingText"
      via: "mode lookup"
      pattern: "LANGUAGE_MATRIX\\[.*\\]\\.loadingText"
---

<objective>
Implement mode-specific loading states, error handling, and toast notification system.

Purpose: Implements requirements UI-05 (loading states) and UI-06 (error/success feedback). Users should receive contextually appropriate feedback that matches their interface mode.

Output: Loading overlay with mode-specific messages, error handler with mode-appropriate prefixes, toast notification system with mode accent colors.
</objective>

<execution_context>
@/Users/dipta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dipta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interface-differentiation/02-CONTEXT.md
@.planning/phases/02-interface-differentiation/02-RESEARCH.md
@pulsecraft_ui/shapeshifter.js
@pulsecraft_ui/style.css
@pulsecraft_ui/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mode-aware loading functions</name>
  <files>pulsecraft_ui/shapeshifter.js</files>
  <action>
Add loading control methods to InterfaceShapeshifter class:

```javascript
/**
 * Show loading overlay with mode-specific message
 * @param {string} customMessage - Optional override message
 */
showLoading(customMessage = null) {
    const overlay = document.getElementById('loadingOverlay');
    const textElement = overlay?.querySelector('.loading-text');

    if (!overlay) {
        console.warn('Loading overlay not found');
        return;
    }

    // Get mode-specific loading text
    const lang = this.LANGUAGE_MATRIX[this.mode];
    const message = customMessage || lang?.loadingText || 'Processing...';

    if (textElement) {
        textElement.textContent = message;
    }

    overlay.classList.remove('hidden');

    // Apply mode accent to spinner
    const spinner = overlay.querySelector('.spinner');
    if (spinner) {
        spinner.style.borderTopColor = `var(--accent-primary)`;
    }
}

/**
 * Hide loading overlay
 */
hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}
```

Also extend LANGUAGE_MATRIX with additional loading message variants:

```javascript
// Add to branding mode:
loadingAnalyze: 'Analyzing brand voice...',
loadingSave: 'Crystallizing brand profile...',
loadingGenerate: 'Creating brand content...',

// Add to author mode:
loadingAnalyze: 'Capturing your style...',
loadingSave: 'Saving writing voice...',
loadingGenerate: 'Writing in your voice...',

// Add to therapy mode:
loadingAnalyze: 'Reflecting on your words...',
loadingSave: 'Documenting your journey...',
loadingGenerate: 'Generating reflection...',
```

Export functions globally for use by script.js:

```javascript
// Add at the end of shapeshifter.js, after class instantiation
window.showLoading = (msg) => window.pulsecraftShapeshifter?.showLoading(msg);
window.hideLoading = () => window.pulsecraftShapeshifter?.hideLoading();
```

WHY: Centralized loading functions ensure consistent mode-aware feedback. Global exports maintain backward compatibility with existing code in script.js.
  </action>
  <verify>
In browser console on /branding:
```javascript
window.showLoading();
// Verify loading overlay shows "Analyzing brand voice..."
window.hideLoading();
```
Repeat on /author (should show "Capturing your style...") and /self-reflection (should show "Reflecting on your words...").
  </verify>
  <done>
Loading overlay displays mode-specific messages, spinner uses mode accent color.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create toast notification system with mode styling</name>
  <files>pulsecraft_ui/shapeshifter.js, pulsecraft_ui/style.css, pulsecraft_ui/index.html</files>
  <action>
**In style.css**, add toast notification styles:

```css
/* Toast Notification System */
#toastContainer {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 400px;
}

.toast {
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer;
}

.toast:hover {
    opacity: 0.95;
}

.toast-success {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-hover) 100%);
}

.toast-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.toast-info {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
}

.toast-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.toast .toast-icon {
    font-size: 1.1rem;
    flex-shrink: 0;
}

.toast .toast-message {
    flex-grow: 1;
    line-height: 1.4;
}

.toast.fade-out {
    animation: fadeOutRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

/* Mobile adjustments */
@media (max-width: 480px) {
    #toastContainer {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
        max-width: none;
    }
}
```

**In shapeshifter.js**, add toast methods:

```javascript
/**
 * Show toast notification
 * @param {string} message - Message to display
 * @param {string} type - 'success' | 'error' | 'info' | 'warning'
 * @param {number} duration - Auto-dismiss time in ms (default 5000)
 */
showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer');
    if (!container) {
        console.warn('Toast container not found');
        return;
    }

    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.setAttribute('role', 'status');
    toast.innerHTML = `
        <i class="fas ${icons[type]} toast-icon"></i>
        <span class="toast-message">${message}</span>
    `;

    // Click to dismiss
    toast.addEventListener('click', () => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
    });

    container.appendChild(toast);

    // Auto-dismiss
    if (duration > 0) {
        setTimeout(() => {
            if (toast.parentNode) {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }
        }, duration);
    }
}

/**
 * Show mode-specific success message
 * @param {string} action - The action that succeeded (e.g., 'save', 'generate')
 */
showSuccess(action = 'default') {
    const lang = this.LANGUAGE_MATRIX[this.mode];
    const messages = {
        save: lang?.saveSuccess || 'Saved successfully!',
        generate: `${lang?.generateAction || 'Content'} generated!`,
        default: 'Success!'
    };

    this.showToast(messages[action] || messages.default, 'success');
}

/**
 * Show mode-specific error message
 * @param {Error|string} error - The error object or message
 */
showError(error) {
    const lang = this.LANGUAGE_MATRIX[this.mode];
    const prefix = lang?.errorPrefix || 'Operation failed';
    const errorMessage = typeof error === 'string' ? error : error?.message || 'Unknown error';

    this.showToast(`${prefix}: ${errorMessage}`, 'error', 7000);
}
```

Add errorPrefix to each mode in LANGUAGE_MATRIX:

```javascript
// branding:
errorPrefix: 'Brand voice extraction failed',

// author:
errorPrefix: 'Writing voice capture failed',

// therapy:
errorPrefix: 'Reflection analysis failed',
```

Global exports:
```javascript
window.showToast = (msg, type, dur) => window.pulsecraftShapeshifter?.showToast(msg, type, dur);
window.showSuccess = (action) => window.pulsecraftShapeshifter?.showSuccess(action);
window.showError = (err) => window.pulsecraftShapeshifter?.showError(err);
```

**In index.html**, verify toast container exists (it does at line 18):
```html
<div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
```

Remove the inline Tailwind classes since we're styling with CSS now:
```html
<div id="toastContainer"></div>
```

WHY: Toast notifications provide non-blocking feedback. Mode-specific prefixes maintain contextual consistency per CONTEXT.md.
  </action>
  <verify>
On /branding:
```javascript
window.showToast('Test message', 'success');  // Green toast appears
window.showToast('Error test', 'error');  // Red toast appears
window.showSuccess('save');  // Shows "Brand profile saved!"
window.showError(new Error('Test'));  // Shows "Brand voice extraction failed: Test"
```
  </verify>
  <done>
Toast notifications appear with correct styling, use mode accent colors for success, and show mode-specific error prefixes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate loading and feedback with existing operations</name>
  <files>pulsecraft_ui/shapeshifter.js</files>
  <action>
The existing loading overlay in script.js likely uses direct DOM manipulation. We need to ensure our new functions are used consistently. Add an `initFeedbackSystem()` method that patches existing behavior:

```javascript
/**
 * Initialize feedback system and patch existing loading behavior
 */
initFeedbackSystem() {
    // Override existing loading behavior if present
    const existingShowLoading = window.showLoadingOverlay;
    const existingHideLoading = window.hideLoadingOverlay;

    // Provide backward-compatible wrappers
    window.showLoadingOverlay = (msg) => this.showLoading(msg);
    window.hideLoadingOverlay = () => this.hideLoading();

    console.log('shapeshifter.js: Feedback system initialized');
}
```

Call this in `init()`:
```javascript
init() {
    console.log('shapeshifter.js: Initializing with mode:', this.mode);

    // ... existing code ...

    // Initialize feedback system
    this.initFeedbackSystem();

    // ... rest of existing code ...
}
```

Also update `applySpecialEffects()` to ensure loading text updates when mode changes:

```javascript
applySpecialEffects(colors) {
    // ... existing effects code ...

    // Apply mode-specific loading text
    const loadingTextElement = document.querySelector('.loading-text');
    if (loadingTextElement) {
        loadingTextElement.textContent = this.LANGUAGE_MATRIX[this.mode]?.loadingText || 'Processing...';
    }

    // Update spinner color with mode accent
    const spinner = document.querySelector('.loading-overlay .spinner');
    if (spinner) {
        spinner.style.borderTopColor = `var(--accent-primary)`;
    }
}
```

WHY: Backward compatibility ensures existing code continues working while new code uses mode-aware feedback.
  </action>
  <verify>
Trigger an actual voice analysis on /branding:
1. Enter text in the input
2. Click "Build Brand Voice"
3. Verify loading overlay shows "Analyzing brand voice..." with blue spinner
4. Verify toast shows success message on completion
  </verify>
  <done>
Loading and feedback systems are integrated with existing operations and display mode-appropriate messages.
  </done>
</task>

</tasks>

<verification>
1. Loading overlay shows correct mode-specific text for each mode
2. Spinner border color matches mode accent
3. Toast notifications appear and auto-dismiss
4. Success toasts use mode success messages
5. Error toasts use mode error prefixes
6. All three modes (branding, author, therapy) have distinct loading messages
</verification>

<success_criteria>
- Branding: "Analyzing brand voice...", "Brand profile saved!", "Brand voice extraction failed: {error}"
- Author: "Capturing your style...", "Writing style captured!", "Writing voice capture failed: {error}"
- Self-Reflection: "Reflecting on your words...", "Voice pattern documented!", "Reflection analysis failed: {error}"
- Toast notifications slide in from right, auto-dismiss after 5s (7s for errors)
- Toast success color uses mode accent
- Toast error always red for visibility
</success_criteria>

<output>
After completion, create `.planning/phases/02-interface-differentiation/02-03-SUMMARY.md`
</output>
